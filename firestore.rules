rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Simplified rules for development/testing - allows authenticated users to read/write
    // Students collection
    match /students/{studentId} {
      allow read, write: if request.auth != null;

      // Per-student history subcollection (activity logs)
      match /history/{entryId} {
        allow read, write: if request.auth != null;
      }
    }

    // Teachers collection  
    match /teachers/{teacherId} {
      allow read, write: if request.auth != null;
    }

    // Teacher assignments collection
    match /teacherAssignments/{teacherId} {
      allow read, write: if request.auth != null;
    }

    // Buildings collection (polygons for geofencing)
    match /buildings/{buildingId} {
      // Allow all authenticated users to read building polygons
      allow read: if request.auth != null;

      // Restrict writes to authenticated users; add basic validation
      allow create, update: if request.auth != null
        && request.resource.data.keys().hasOnly(['name','polygon','polygons','color','level','centroid'])
        && (
          // Require either 'polygon' or 'polygons' with at least 3 vertices
          ((request.resource.data.polygon is list && request.resource.data.polygon.size() >= 3) ||
           (request.resource.data.polygons is list && request.resource.data.polygons.size() >= 3))
        );
      allow delete: if request.auth != null; // tighten later if needed
    }
  }
}
